<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Torino Chocolate Experience üç´</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Cinzel:wght@400;600&family=Lato:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      font-family: 'Lato', sans-serif;
      min-height: 100vh;
      color: white;
      background-color: #1a0f0a;
      overflow-x: hidden;
      position: relative;
    }

    /* SFONDO PRINCIPALE: Cioccolata + Mole Antonelliana */
    body {
      background: 
        /* Overlay scuro per leggibilit√† */
        linear-gradient(180deg, rgba(13, 8, 6, 0.88) 0%, rgba(26, 15, 10, 0.92) 50%, rgba(45, 27, 18, 0.95) 100%),
        /* Immagine Mole Antonelliana */
        url('https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=1920&q=80') center top/cover no-repeat fixed,
        /* Sfondo di fallback cioccolato */
        linear-gradient(135deg, #3d2314 0%, #5d4037 50%, #3d2314 100%);
      background-attachment: fixed;
    }

    /* Effetto cioccolata che scorre in sovrapposizione */
    .chocolate-wave {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 200px;
      background: url('https://img.freepik.com/premium-vector/liquid-chocolate-splash-wave-white-background_158582-667.jpg') center bottom/cover no-repeat;
      opacity: 0.15;
      pointer-events: none;
      z-index: 0;
      mix-blend-mode: multiply;
    }

    /* Gocce di cioccolata animate */
    .chocolate-drop {
      position: fixed;
      background: linear-gradient(180deg, #5d4037 0%, #3d2314 100%);
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      opacity: 0.4;
      pointer-events: none;
      z-index: 0;
      animation: drip 10s ease-in-out infinite;
    }

    @keyframes drip {
      0%, 100% { transform: translateY(-100px) scale(1); opacity: 0; }
      10% { opacity: 0.4; }
      90% { opacity: 0.4; }
      100% { transform: translateY(100vh) scale(0.8); opacity: 0; }
    }

    /* Overlay iniziale */
    #fireworks-overlay {
      position: fixed;
      inset: 0;
      background: 
        linear-gradient(135deg, rgba(13, 8, 6, 0.95) 0%, rgba(26, 15, 10, 0.98) 100%),
        url('https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=1920&q=80') center/cover no-repeat;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
      opacity: 1;
      transition: opacity 1.2s ease-out;
      padding: 20px;
    }

    #fireworks-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    .birthday-text {
      position: relative;
      z-index: 10000;
      font-family: 'Playfair Display', serif;
      font-size: clamp(28px, 10vw, 64px);
      text-align: center;
      color: #f4e4c1;
      text-shadow: 0 0 30px rgba(212, 175, 55, 0.9), 0 0 60px rgba(212, 175, 55, 0.5);
      font-weight: 700;
      animation: popIn 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      letter-spacing: 2px;
      line-height: 1.2;
    }

    .birthday-heart{
      display: inline-block;
      margin-left: 10px;
      color: #e74c3c;
      text-shadow: 0 0 18px rgba(231,76,60,0.55);
      transform-origin: center;
      animation: heartbeat 1.05s ease-in-out infinite;
    }
    @keyframes heartbeat{
      0%, 100% { transform: scale(1); }
      20%      { transform: scale(1.22); }
      40%      { transform: scale(1.05); }
      60%      { transform: scale(1.30); }
      80%      { transform: scale(1.08); }
    }

    .birthday-subtitle {
      position: relative;
      z-index: 10000;
      font-family: 'Cinzel', serif;
      font-size: clamp(12px, 4vw, 20px);
      color: #d4af37;
      margin-top: 25px;
      letter-spacing: 4px;
      text-transform: uppercase;
      font-weight: 400;
      animation: fadeInUp 1s ease-out 0.8s both;
      text-align: center;
    }

    @keyframes popIn {
      from { transform: scale(0.2) rotate(-15deg); opacity: 0; }
      to   { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 15px 60px;
      position: relative;
      z-index: 1;
      width: 100%;
    }

    .hero {
      text-align: center;
      margin-bottom: 20px;
      animation: fadeInUp 1s ease-out;
      background: rgba(0,0,0,0.4);
      padding: 30px 15px;
      border-radius: 20px;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(212, 175, 55, 0.3);
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .main-title {
      font-family: 'Playfair Display', serif;
      font-size: clamp(24px, 8vw, 48px);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 3px;
      color: #f4e4c1;
      text-shadow: 0 4px 20px rgba(0,0,0,0.9), 0 0 40px rgba(212, 175, 55, 0.5);
      margin-bottom: 10px;
      line-height: 1.2;
    }

    .subtitle-date {
      font-family: 'Cinzel', serif;
      font-size: clamp(11px, 3.5vw, 18px);
      color: #d4af37;
      letter-spacing: 3px;
      text-transform: uppercase;
      text-shadow: 0 2px 10px rgba(0,0,0,0.9);
    }

    .start-btn {
      display: inline-block;
      margin-top: 25px;
      padding: 16px 40px;
      background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
      color: #1a0f0a;
      font-family: 'Cinzel', serif;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4), 0 0 0 3px rgba(212, 175, 55, 0.2);
      transition: all 0.4s ease;
      animation: pulse 2s ease-in-out infinite;
      width: 90%;
      max-width: 300px;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4), 0 0 0 3px rgba(212, 175, 55, 0.2); }
      50% { transform: scale(1.05); box-shadow: 0 15px 40px rgba(212, 175, 55, 0.6), 0 0 0 5px rgba(212, 175, 55, 0.3); }
    }

    .start-btn:hover, .start-btn:active {
      background: linear-gradient(135deg, #f4e4c1 0%, #d4af37 100%);
      transform: scale(1.05);
    }

    .start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      animation: none;
      transform: none;
    }

    .journey-panel {
      max-width: 760px;
      margin: 15px auto 0;
      padding: 20px;
      border-radius: 18px;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(212, 175, 55, 0.4);
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      display: none;
      opacity: 0;
      transform: translateY(12px);
      backdrop-filter: blur(10px);
      width: 95%;
    }
    .journey-panel.show { display: block; animation: panelIn .6s ease-out forwards; }
    @keyframes panelIn { to { opacity: 1; transform: translateY(0); } }
    .journey-panel h3 {
      font-family: 'Cinzel', serif;
      font-size: 14px;
      letter-spacing: 3px;
      color: #d4af37;
      text-transform: uppercase;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .journey-panel p { color: rgba(244,228,193,0.95); line-height: 1.7; font-size: 15px; }

    .map-wrapper {
      max-width: 1000px;
      margin: 0 auto;
      max-height: 0;
      opacity: 0;
      transform: translateY(18px);
      overflow: hidden;
      transition: max-height 1.2s ease, opacity 1.2s ease, transform 1.2s ease;
      pointer-events: none;
      width: 100%;
      padding: 0 10px;
    }
    .map-wrapper.visible {
      max-height: 600px;
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .map-section {
      position: relative;
      height: 350px;
      margin: 20px 0 10px;
      background: linear-gradient(180deg, #1e3a5f 0%, #2d5a87 50%, #1e3a5f 100%);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6), inset 0 0 100px rgba(0,0,0,0.3);
      border: 2px solid rgba(212, 175, 55, 0.4);
    }
    .map-svg { width: 100%; height: 100%; display: block; }

    .stop-dot {
      fill: rgba(0,0,0,0.55);
      stroke: #d4af37;
      stroke-width: 3;
    }
    .stop-ico {
      fill: none;
      stroke: #d4af37;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .stop-text {
      fill: #d4af37;
      font-family: 'Cinzel', serif;
      font-size: 12px;
      letter-spacing: 1px;
      text-anchor: middle;
      text-shadow: 0 2px 4px rgba(0,0,0,0.9);
      font-weight: 600;
    }
    .stop.active .stop-dot {
      stroke: #4ade80;
      filter: drop-shadow(0 0 10px rgba(74,222,128,0.65));
    }
    .stop.active .stop-ico { stroke: #4ade80; }
    .stop.completed .stop-dot {
      fill: rgba(22,101,52,0.82);
      stroke: #4ade80;
    }
    .stop.completed .stop-ico { stroke: #e7ffe9; }

    .tram-icon { filter: drop-shadow(0 10px 20px rgba(0,0,0,0.55)); }

    .experience-cards { margin-top: 20px; width: 100%; }

    .card {
      background: linear-gradient(145deg, rgba(255,253,249,0.97) 0%, rgba(245,240,232,0.97) 100%);
      color: #333;
      border-radius: 20px;
      box-shadow: 0 30px 70px rgba(0,0,0,0.7), 0 0 0 2px rgba(212, 175, 55, 0.4);
      margin: 25px auto;
      max-width: 700px;
      display: none;
      overflow: hidden;
      opacity: 0;
      transform: translateY(30px);
      backdrop-filter: blur(10px);
      width: 95%;
    }

    .card.show {
      display: block;
      animation: cardAppear 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .card.hiding {
      display: block;
      animation: cardDisappear 0.45s ease-in forwards;
    }

    @keyframes cardAppear {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes cardDisappear {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(18px) scale(0.985); }
    }

    .card-image-wrapper { position: relative; overflow: hidden; height: 200px; }
    .card-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.6s ease; }
    .card:active .card-img { transform: scale(1.05); }

    .card-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-family: 'Cinzel', serif;
      font-size: 11px;
      letter-spacing: 2px;
      text-transform: uppercase;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .card-content { padding: 25px 20px; }

    .card h2 {
      font-family: 'Playfair Display', serif;
      color: #3d2314;
      font-size: 24px;
      margin-bottom: 12px;
      font-weight: 700;
      line-height: 1.3;
    }

    .card p {
      color: #5a4a3a;
      font-size: 15px;
      line-height: 1.7;
      margin-bottom: 18px;
    }

    .feature-list { list-style: none; margin-bottom: 20px; }
    .feature-list li {
      padding: 8px 0;
      border-bottom: 1px dashed rgba(212, 175, 55, 0.4);
      color: #4a3f35;
      font-size: 14px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      line-height: 1.5;
    }
    .feature-list li:last-child { border-bottom: none; }
    .feature-list li::before { content: "‚ú¶"; color: #d4af37; font-size: 14px; flex-shrink: 0; margin-top: 2px; }

    .btn {
      display: block;
      padding: 14px 30px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      font-size: 12px;
      transition: all 0.4s ease;
      text-align: center;
      border: none;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      width: 100%;
      margin-bottom: 10px;
    }

    .btn-primary { background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: white; }
    .btn-primary:hover {
      background: linear-gradient(135deg, #a0522d 0%, #cd853f 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(139, 69, 19, 0.4);
    }

    .btn-gold { background: linear-gradient(135deg, #b8860b 0%, #d4af37 100%); color: white; }
    .btn-gold:hover {
      background: linear-gradient(135deg, #d4af37 0%, #f0d878 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(184, 134, 11, 0.4);
    }

    .btn-teal { background: linear-gradient(135deg, #2e8b57 0%, #3cb371 100%); color: white; }
    .btn-teal:hover {
      background: linear-gradient(135deg, #3cb371 0%, #66cdaa 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(46, 139, 87, 0.4);
    }

    .btn-dark { background: linear-gradient(135deg, #3d2314 0%, #5d4037 100%); color: white; }
    .btn-dark:hover {
      background: linear-gradient(135deg, #5d4037 0%, #795548 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(61, 35, 20, 0.4);
    }

    .btn-group { display: flex; flex-direction: column; gap: 10px; width: 100%; }

    .continue-btn {
      display: block;
      margin: 20px auto 0;
      padding: 14px 35px;
      background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
      color: white;
      font-family: 'Cinzel', serif;
      font-size: 14px;
      letter-spacing: 2px;
      text-transform: uppercase;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
      width: 90%;
      max-width: 280px;
    }

    .continue-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 35px rgba(212, 175, 55, 0.6);
    }

    .celebration-box {
      background: linear-gradient(145deg, #fff8e7 0%, #ffefd5 100%);
      padding: 25px 20px;
      border-radius: 15px;
      text-align: center;
      margin-top: 25px;
      border: 3px solid #d4af37;
      box-shadow: inset 0 0 40px rgba(212, 175, 55, 0.15);
      position: relative;
      overflow: hidden;
    }

    .celebration-box strong {
      font-family: 'Playfair Display', serif;
      color: #8b4513;
      font-size: 22px;
      display: block;
      margin-bottom: 10px;
    }

    .celebration-box span { font-size: 15px; color: #6b5a4a; line-height: 1.6; display: block; }

    .particle { position: fixed; pointer-events: none; z-index: 9998; }

    /* RESPONSIVE TABLET */
    @media (min-width: 768px) {
      .container { padding: 30px 20px 80px; }
      .hero { padding: 40px 30px; }
      .main-title { font-size: clamp(32px, 6vw, 48px); letter-spacing: 5px; }
      .subtitle-date { font-size: clamp(14px, 2.5vw, 18px); letter-spacing: 4px; }
      .start-btn { width: auto; padding: 18px 50px; font-size: 18px; }
      .map-section { height: 430px; border-radius: 30px; }
      .stop-text { font-size: 14px; letter-spacing: 1.5px; }
      .card-image-wrapper { height: 250px; }
      .card-content { padding: 35px; }
      .card h2 { font-size: 28px; }
      .card p { font-size: 16px; }
      .feature-list li { font-size: 15px; padding: 10px 0; }
      .btn { display: inline-block; width: auto; padding: 14px 35px; font-size: 13px; margin-bottom: 0; }
      .btn-group { flex-direction: row; flex-wrap: wrap; }
      .continue-btn { width: auto; padding: 15px 40px; font-size: 16px; }
      .celebration-box { padding: 30px; }
      .celebration-box strong { font-size: 26px; }
      .celebration-box span { font-size: 16px; }
    }

    /* RESPONSIVE DESKTOP */
    @media (min-width: 1024px) {
      .map-wrapper { padding: 0; }
      .card { width: 100%; }
    }

    /* FIX PER MOBILE PICCOLI */
    @media (max-width: 380px) {
      .main-title { font-size: 22px; letter-spacing: 2px; }
      .subtitle-date { font-size: 10px; letter-spacing: 2px; }
      .card h2 { font-size: 20px; }
      .stop-text { font-size: 10px; }
      .map-section { height: 280px; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }

    /* FIX SCROLL SU IOS */
    @supports (-webkit-touch-callout: none) {
      body {
        background-attachment: scroll;
      }
    }
  </style>
</head>

<body>
  <!-- Onda di cioccolata decorativa -->
  <div class="chocolate-wave"></div>
  
  <!-- Gocce di cioccolata -->
  <div class="chocolate-drop" style="width: 20px; height: 30px; left: 10%; animation-delay: 0s;"></div>
  <div class="chocolate-drop" style="width: 15px; height: 25px; left: 25%; animation-delay: 2s;"></div>
  <div class="chocolate-drop" style="width: 25px; height: 35px; left: 70%; animation-delay: 4s;"></div>
  <div class="chocolate-drop" style="width: 18px; height: 28px; left: 85%; animation-delay: 6s;"></div>
  <div class="chocolate-drop" style="width: 22px; height: 32px; left: 45%; animation-delay: 3s;"></div>

  <!-- Overlay iniziale -->
  <div id="fireworks-overlay">
    <canvas id="fireworks-canvas"></canvas>
    <div class="birthday-text">Buon Compleanno PIPPO <span class="birthday-heart" aria-hidden="true">‚ù§</span></div>
    <div class="birthday-subtitle">Un viaggio ti attende...</div>
  </div>

  <div class="container">
    <header class="hero" id="hero">
      <h1 class="main-title">Torino Chocolate Experience üç´</h1>
      <div class="subtitle-date">28 Febbraio ‚Äî 1 Marzo 2026</div>
      <button class="start-btn" id="startBtn" onclick="startJourney()">üöÉ Inizia il Viaggio</button>
    </header>

    <section class="journey-panel" id="journeyPanel" aria-live="polite">
      <h3>Un viaggio ti attende‚Ä¶</h3>
      <p>Tra poco comparir√† la mappa: il tram far√† tappa in tre punti speciali. Quando arriva a un pallino, si sblocca l'esperienza corrispondente.</p>
    </section>

    <div class="map-wrapper" id="mapWrapper">
      <section class="map-section">
        <svg class="map-svg" id="torinoMap" viewBox="0 0 1000 450" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Mappa stilizzata di Torino con percorso del tram">
          <defs>
            <linearGradient id="bg" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#1e3a5f"/>
              <stop offset="50%" stop-color="#2d5a87"/>
              <stop offset="100%" stop-color="#1e3a5f"/>
            </linearGradient>

            <filter id="softGlow">
              <feGaussianBlur stdDeviation="3" result="blur"/>
              <feMerge>
                <feMergeNode in="blur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>

            <symbol id="ico-tram" viewBox="0 0 24 24">
              <rect x="5" y="7" width="14" height="10" rx="2"/>
              <path d="M8 17v2M16 17v2"/>
              <circle cx="8" cy="19" r="1.2"/>
              <circle cx="16" cy="19" r="1.2"/>
              <path d="M5 11h14"/>
            </symbol>

            <symbol id="ico-hotel" viewBox="0 0 24 24">
              <path d="M4 20h16"/>
              <path d="M6 20V8l6-3 6 3v12"/>
              <path d="M10 20v-4h4v4"/>
              <path d="M9 10h2M13 10h2M9 13h2M13 13h2"/>
            </symbol>

            <symbol id="ico-choco" viewBox="0 0 24 24">
              <rect x="6" y="6" width="12" height="14" rx="2"/>
              <path d="M10 6v14M14 6v14"/>
              <path d="M6 11h12M6 15h12"/>
            </symbol>
          </defs>

          <rect x="0" y="0" width="1000" height="450" fill="url(#bg)"/>

          <path d="M120 310
                   C120 190 240 120 390 110
                   C520 100 700 130 820 210
                   C900 270 890 350 800 380
                   C650 430 390 420 240 370
                   C160 340 120 330 120 310 Z"
                fill="rgba(255,255,255,0.06)"
                stroke="rgba(244,228,193,0.25)"
                stroke-width="2"/>

          <text x="500" y="255"
                text-anchor="middle"
                font-family="Cinzel, serif"
                font-size="78"
                letter-spacing="14"
                fill="rgba(244,228,193,0.14)">
            TORINO
          </text>

          <path d="M760 40 C820 110 835 160 820 220 C800 300 820 340 880 410"
                fill="none" stroke="rgba(74,144,164,0.85)" stroke-width="26" stroke-linecap="round"/>
          <path d="M760 40 C820 110 835 160 820 220 C800 300 820 340 880 410"
                fill="none" stroke="rgba(255,255,255,0.22)" stroke-width="4" stroke-linecap="round"/>

          <g opacity="0.25">
            <path d="M210 150 L740 320" stroke="#d4af37" stroke-width="2" stroke-dasharray="6 10"/>
            <path d="M250 340 L760 170" stroke="#d4af37" stroke-width="2" stroke-dasharray="6 10"/>
            <path d="M330 120 L560 410" stroke="#d4af37" stroke-width="2" stroke-dasharray="6 10"/>
          </g>

          <path id="tramRoute"
                d="M170 300
                   C190 180 310 135 430 135
                   C580 135 720 165 800 235
                   C865 295 845 360 770 375
                   C640 400 430 385 280 350
                   C205 332 175 325 170 300 Z"
                fill="none"
                stroke="rgba(212,175,55,0.65)"
                stroke-width="6"
                stroke-linecap="round"
                filter="url(#softGlow)"/>

          <g class="stop" id="stop1">
            <circle class="stop-dot" r="18"></circle>
            <use class="stop-ico" href="#ico-tram" x="-10" y="-10" width="20" height="20"></use>
            <text class="stop-text" y="-32">Choco Tram</text>
          </g>

          <g class="stop" id="stop2">
            <circle class="stop-dot" r="18"></circle>
            <use class="stop-ico" href="#ico-hotel" x="-10" y="-10" width="20" height="20"></use>
            <text class="stop-text" y="-32">Palazzo Bellezia</text>
          </g>

          <g class="stop" id="stop3">
            <circle class="stop-dot" r="18"></circle>
            <use class="stop-ico" href="#ico-choco" x="-10" y="-10" width="20" height="20"></use>
            <text class="stop-text" y="-32">Peyrano</text>
          </g>

          <g id="tram" class="tram-icon">
            <rect x="-34" y="-16" width="68" height="32" rx="6" fill="#d4af37" stroke="rgba(26,15,10,0.7)" stroke-width="2"/>
            <rect x="-26" y="-9" width="18" height="12" rx="2" fill="#87ceeb" opacity="0.95"/>
            <rect x="-4"  y="-9" width="18" height="12" rx="2" fill="#87ceeb" opacity="0.95"/>
            <rect x="18"  y="-9" width="18" height="12" rx="2" fill="#87ceeb" opacity="0.95"/>
            <circle cx="-30" cy="13" r="4" fill="#ffeb3b"/>
            <circle cx="30"  cy="13" r="4" fill="#ffeb3b"/>
            <circle cx="-18" cy="20" r="5" fill="#2a2a2a"/>
            <circle cx="0"   cy="20" r="5" fill="#2a2a2a"/>
            <circle cx="18"  cy="20" r="5" fill="#2a2a2a"/>
          </g>

          <text x="880" y="60" fill="rgba(244,228,193,0.85)" font-size="18" text-anchor="end"
                font-family="Cinzel, serif" letter-spacing="2">PO</text>
        </svg>
      </section>
    </div>

    <section class="experience-cards">
      <div id="card1" class="card">
        <div class="card-image-wrapper">
          <span class="card-badge">Tappa 1</span>
          <img src="https://imgcdn.bokun.tools/15512974-6f29-48af-8be0-268d16d92225.jpeg?fm=auto&mode=fit&crop=center&dpr=2&w=1946" class="card-img" alt="Choco Tram" loading="lazy">
        </div>
        <div class="card-content">
          <h2>üöÉ Choco Tram Experience</h2>
          <p>Il nostro viaggio inizia a bordo di un <strong>tram storico d'epoca</strong> che ci porter√† per le vie pi√π affascinanti di Torino, la capitale italiana del cioccolato.</p>
          <ul class="feature-list">
            <li>Giro panoramico del centro storico patrimonio UNESCO</li>
            <li>Degustazione di giandujotti artigianali a bordo</li>
            <li>Racconti sulla storia del cioccolato piemontese</li>
            <li>Visita al Museo del Cioccolato e del Gianduja</li>
          </ul>
          <a href="https://www.choco-story-torino.it/choco-tram-2026" target="_blank" class="btn btn-primary">Scopri il Choco Tram ‚ú®</a>
          <button class="continue-btn" onclick="continueJourney(2)">Continua il Viaggio ‚Üí</button>
        </div>
      </div>

      <div id="card2" class="card">
        <div class="card-image-wrapper">
          <span class="card-badge">Tappa 2</span>
          <img src="https://palazzobellezia.it/wp-content/uploads/Img_stanza-11.webp" class="card-img" alt="Palazzo Bellezia" loading="lazy">
        </div>
        <div class="card-content">
          <h2>üè® Palazzo Bellezia ‚Äî Junior Suite</h2>
          <p>Proseguiamo il nostro viaggio verso il lusso. Ho prenotato una <strong>notte da sogno</strong> in una delle suite pi√π eleganti di Torino, nel cuore del centro storico.</p>
          <ul class="feature-list">
            <li><strong>Junior Suite 45mq</strong> ‚Äî Eleganza e comfort assoluto</li>
            <li><strong>Accesso SPA incluso</strong> ‚Äî Piscina, Sauna, Bagno Turco</li>
            <li><strong>Colazione da Re</strong> ‚Äî Buffet gourmet con prodotti locali</li>
            <li>Posizione privilegiata nel centro storico</li>
          </ul>
          <div class="btn-group">
            <a href="https://palazzobellezia.it/camere/#junior-suite" target="_blank" class="btn btn-gold">Guarda la Suite üëë</a>
            <a href="https://palazzobellezia.it/spa/" target="_blank" class="btn btn-teal">Esplora la SPA üßñ‚Äç‚ôÄÔ∏è</a>
          </div>
          <button class="continue-btn" onclick="continueJourney(3)">Prosegui ‚Üí</button>
        </div>
      </div>

      <div id="card3" class="card">
        <div class="card-image-wrapper">
          <span class="card-badge">Tappa Finale</span>
          <img src="https://www.peyrano.com/cdn/shop/files/Screenshot_2025-10-20_alle_11.21.16_2032x.png?v=1760952106" class="card-img" alt="Peyrano" loading="lazy">
        </div>
        <div class="card-content">
          <h2>üç´ Peyrano ‚Äî Factory Tour</h2>
          <p>Il <strong>gran finale</strong> del nostro viaggio ci porta nel laboratorio storico della celebre cioccolateria Peyrano, simbolo della tradizione cioccolatiera torinese dal 1915.</p>
          <ul class="feature-list">
            <li>Tour esclusivo della fabbrica storica</li>
            <li>Tasting experience dei cioccolatini iconici</li>
            <li>Workshop di decorazione tavolette</li>
          </ul>
          <a href="https://www.peyrano.com/" target="_blank" class="btn btn-dark">Scopri l'Esperienza üé©</a>

          <div class="celebration-box">
            <strong>üéÇ Buon Compleanno! üéÇ</strong>
            <span>Prepara la valigia, √® tutto pronto!<br>Un weekend indimenticabile ci aspetta ‚ù§Ô∏è</span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    let currentStop = 0;
    let isMoving = false;

    const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    function smartScrollIntoView(el, opts) {
      const behavior = reduceMotion ? 'auto' : ((opts && opts.behavior) || 'smooth');
      const block = (opts && opts.block) || 'start';
      try { 
        el.scrollIntoView({ behavior, block }); 
      } catch (e) { 
        el.scrollIntoView(true); 
      }
    }

    const mapWrapper = document.getElementById('mapWrapper');
    const journeyPanel = document.getElementById('journeyPanel');

    function startJourney() {
      if (isMoving) return;

      const startBtn = document.getElementById('startBtn');
      startBtn.disabled = true;
      startBtn.textContent = 'üöÉ Viaggio in corso...';

      journeyPanel.classList.add('show');
      smartScrollIntoView(document.getElementById('hero'), { block: 'start' });

      setTimeout(() => {
        mapWrapper.classList.add('visible');
        setTimeout(() => smartScrollIntoView(mapWrapper, { block: 'start' }), 250);
        setTimeout(() => moveToStop(1), reduceMotion ? 50 : 1100);
      }, reduceMotion ? 50 : 450);
    }

    function hideCard(cardEl) {
      if (!cardEl) return Promise.resolve();
      if (!cardEl.classList.contains('show')) return Promise.resolve();

      if (reduceMotion) {
        cardEl.classList.remove('show');
        cardEl.classList.remove('hiding');
        return Promise.resolve();
      }

      return new Promise((resolve) => {
        let done = false;

        const finish = () => {
          if (done) return;
          done = true;
          cardEl.classList.remove('show');
          cardEl.classList.remove('hiding');
          cardEl.removeEventListener('animationend', onEnd);
          resolve();
        };

        const onEnd = (ev) => {
          if (ev.animationName === 'cardDisappear') finish();
        };

        cardEl.addEventListener('animationend', onEnd);
        cardEl.classList.add('hiding');

        setTimeout(finish, 650);
      });
    }

    function hideAllCardsInstant() {
      for (const n of [1,2,3]) {
        const c = document.getElementById('card' + n);
        c.classList.remove('hiding');
        c.classList.remove('show');
      }
    }

    function createParticles(element) {
      const rect = element.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;

      const colors = ['#d4af37', '#f4e4c1', '#4ade80', '#ffeb3b'];

      for (let i = 0; i < 18; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = centerX + 'px';
        particle.style.top = centerY + 'px';
        particle.style.width = (Math.random() * 10 + 5) + 'px';
        particle.style.height = particle.style.width;
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        particle.style.borderRadius = '50%';
        particle.style.boxShadow = `0 0 10px ${particle.style.backgroundColor}`;
        document.body.appendChild(particle);

        const angle = (Math.PI * 2 / 18) * i;
        const velocity = Math.random() * 90 + 70;
        const vx = Math.cos(angle) * velocity;
        const vy = Math.sin(angle) * velocity;

        particle.animate(
          [
            { transform: 'translate(0, 0) scale(1)', opacity: 1 },
            { transform: `translate(${vx}px, ${vy}px) scale(0)`, opacity: 0 }
          ],
          { duration: 900, easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)' }
        ).onfinish = () => particle.remove();
      }
    }

    function createConfetti() {
      const colors = ['#d4af37', '#f4e4c1', '#8b4513', '#e74c3c', '#4ade80', '#fff'];
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'particle';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.top = '-20px';
        confetti.style.width = Math.random() * 12 + 6 + 'px';
        confetti.style.height = Math.random() * 8 + 4 + 'px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        document.body.appendChild(confetti);

        const duration = Math.random() * 4 + 3;

        confetti.animate(
          [
            { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
            { transform: `translateY(${window.innerHeight + 100}px) rotate(${Math.random() * 720}deg)`, opacity: 0.3 }
          ],
          { duration: duration * 1000, easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)' }
        ).onfinish = () => confetti.remove();
      }
    }

    const route = document.getElementById('tramRoute');
    const tram = document.getElementById('tram');

    let routeLen = 0;
    let tramRaf = null;
    let tramLenNow = 0;

    const stops = {
      1: { id: 'stop1', progress: 0.15 },
      2: { id: 'stop2', progress: 0.50 },
      3: { id: 'stop3', progress: 0.85 }
    };
    const stopLen = {};

    function initRoute() {
      routeLen = route.getTotalLength();
      tramLenNow = 0;
      setTramAtLength(0);
      placeStopsOnRoute();
    }

    function placeStopsOnRoute() {
      for (const k of [1,2,3]) {
        const el = document.getElementById(stops[k].id);
        const len = routeLen * stops[k].progress;
        stopLen[k] = len;

        const p = route.getPointAtLength(len);
        el.setAttribute('transform', `translate(${p.x} ${p.y})`);
      }
    }

    function setTramAtLength(len) {
      const l = Math.max(0, Math.min(len, routeLen));
      const p = route.getPointAtLength(l);
      const p2 = route.getPointAtLength(Math.min(l + 1, routeLen));
      const angle = Math.atan2(p2.y - p.y, p2.x - p.x) * 180 / Math.PI;
      tram.setAttribute('transform', `translate(${p.x} ${p.y}) rotate(${angle})`);
    }

    function animateTramToLength(targetLen, durationMs) {
      if (tramRaf) cancelAnimationFrame(tramRaf);

      const startLen = tramLenNow;
      const delta = targetLen - startLen;

      if (reduceMotion) {
        tramLenNow = targetLen;
        setTramAtLength(targetLen);
        return Promise.resolve();
      }

      return new Promise((resolve) => {
        let startTs = null;

        function step(ts) {
          if (startTs === null) startTs = ts;
          const t = Math.min((ts - startTs) / durationMs, 1);
          const eased = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;

          const len = startLen + delta * eased;
          tramLenNow = len;
          setTramAtLength(len);

          if (t < 1) tramRaf = requestAnimationFrame(step);
          else { tramRaf = null; resolve(); }
        }

        tramRaf = requestAnimationFrame(step);
      });
    }

    async function moveToStop(stopNum) {
      isMoving = true;

      const stopEl = document.getElementById(stops[stopNum].id);
      const targetLen = stopLen[stopNum];

      await animateTramToLength(targetLen, 2200);

      stopEl.classList.add('active');
      if (!reduceMotion) createParticles(stopEl);

      setTimeout(() => {
        stopEl.classList.remove('active');
        stopEl.classList.add('completed');

        hideAllCardsInstant();
        const card = document.getElementById('card' + stopNum);
        card.classList.add('show');
        smartScrollIntoView(card, { block: 'start' });

        isMoving = false;
        currentStop = stopNum;

        if (stopNum === 3 && !reduceMotion) setTimeout(createConfetti, 500);
      }, 900);
    }

    async function continueJourney(nextStop) {
      if (isMoving) return;

      const currentCard = document.getElementById('card' + currentStop);
      await hideCard(currentCard);

      smartScrollIntoView(mapWrapper, { block: 'start' });
      setTimeout(() => moveToStop(nextStop), 450);
    }

    const overlay = document.getElementById('fireworks-overlay');
    const canvas = document.getElementById('fireworks-canvas');
    const ctx = canvas.getContext('2d');

    let fwInterval = null;
    let fwRaf = null;

    const fwParticles = [];
    const fwColors = ['#d4af37', '#f4e4c1', '#e74c3c', '#ff6b6b', '#ffd93d', '#6bcf7f', '#4d96ff', '#ff9f43'];

    function resizeCanvas() {
      const ratio = Math.min(window.devicePixelRatio || 1, 2);
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      canvas.width = Math.floor(window.innerWidth * ratio);
      canvas.height = Math.floor(window.innerHeight * ratio);
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    }

    function createFirework() {
      const x = Math.random() * window.innerWidth;
      const y = Math.random() * window.innerHeight * 0.5 + 100;
      const color = fwColors[Math.floor(Math.random() * fwColors.length)];
      const count = 60;

      for (let i = 0; i < count; i++) {
        const angle = (Math.PI * 2 / count) * i + Math.random() * 0.8;
        const speed = Math.random() * 5 + 3;
        fwParticles.push({
          x, y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          alpha: 1,
          color,
          size: Math.random() * 4 + 2,
          decay: Math.random() * 0.01 + 0.008
        });
      }
    }

    function updateFireworks() {
      ctx.fillStyle = 'rgba(13, 8, 6, 0.12)';
      ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);

      for (let i = fwParticles.length - 1; i >= 0; i--) {
        const p = fwParticles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.05;
        p.alpha -= p.decay;
        p.vx *= 0.97;
        p.vy *= 0.97;

        if (p.alpha <= 0) { fwParticles.splice(i, 1); continue; }

        ctx.save();
        ctx.globalAlpha = p.alpha;
        ctx.fillStyle = p.color;
        ctx.shadowBlur = 15;
        ctx.shadowColor = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      }

      fwRaf = requestAnimationFrame(updateFireworks);
    }

    function stopFireworks() {
      if (fwInterval) { clearInterval(fwInterval); fwInterval = null; }
      if (fwRaf) { cancelAnimationFrame(fwRaf); fwRaf = null; }
      fwParticles.length = 0;
      window.removeEventListener('resize', resizeCanvas);
    }

    function hideOverlay() {
      overlay.style.opacity = '0';
      const onEnd = () => {
        overlay.removeEventListener('transitionend', onEnd);
        overlay.style.display = 'none';
        stopFireworks();
      };
      overlay.addEventListener('transitionend', onEnd);

      setTimeout(() => {
        if (overlay.style.display !== 'none') {
          overlay.style.display = 'none';
          stopFireworks();
        }
      }, 1400);
    }

    // Inizializzazione
    window.addEventListener('load', () => {
      initRoute();

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      if (!reduceMotion) {
        createFirework();
        fwInterval = setInterval(createFirework, 400);
        updateFireworks();
        setTimeout(hideOverlay, 4500);
      } else {
        setTimeout(hideOverlay, 1200);
      }
    });

    // Fix per resize su mobile
    window.addEventListener('resize', () => {
      if (routeLen > 0) {
        placeStopsOnRoute();
        setTramAtLength(tramLenNow);
      }
    });
  </script>
</body>
</html>
